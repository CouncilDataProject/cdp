#!/usr/bin/env python

from cdpprocessor.io.pipelines import LegistarPipe
import subprocess
import argparse
import docker
import json
import os

def main():
    parser = argparse.ArgumentParser(
                                    description="CDP server quick start script")
    parser.add_argument(dest="config",
                        help="OS path for the server config json file")

    args = parser.parse_args()

    if not os.path.exists(args.config):
        raise ValueError("""
Could not find the specified server config from the specified path.
Please review our documentation for an example server config.
""")

    try:
        with open(args.config, "r") as in_file:
            opts = json.load(in_file)

        check_keys = ["legistar_city",
                        "storage_directory",
                        "collection_script",
                        "firebase_config"]
        assert all([key in opts for key in check_keys]), """
Missing required keys... {missing}
""".format(missing=[key not in opts for key in check_keys])

        try:
            test = LegistarPipe(opts["legistar_city"]).get_legistar_object()
        except ValueError:
            raise ValueError("""
Could not find or connect to the specified Legistar connected city.
Please review our documentation for an example server config json file.
""")

        if not os.path.isdir(opts["storage_directory"]):
            raise ValueError("""
Could not find the specified storage directory.
Please review our documentation for an example server config json file.
""")

        if not os.path.exists(opts["collection_script"]):
            raise ValueError("""
Could not find the specified video url list creation python script.
Please review our documentation for an example server config json file.
""")

        # TODO:
        # attempt to load the video collection function using import lib
        # https://stackoverflow.com/questions/67631/how-to-import-a-module-given-the-full-path

        # TODO:
        # create firebase connection check

    except:
        raise ValueError("""
Could not properly load the server config json file provided.
Please review our documentation for an example server config json file.
""")

    print("Server config passed inspection...")
    print("Pulling CDP processing server Docker image...")

    client = docker.from_env()
    client.images.pull("councildataproject/processor")

    print("Starting server with the provided config...")
    print("-" * 80)

    constructed_pipe = ["docker",
                        "run",
                        "-t",
                        "-v",
                        args.config + ":/home/config.json",
                        "councildataproject/processor",
                        "run_cdp_server"]

    subprocess.Popen(constructed_pipe)

if __name__ == "__main__":
    main()
